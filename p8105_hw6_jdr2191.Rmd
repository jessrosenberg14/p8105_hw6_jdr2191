---
title: "p8105_hw6_jdr2191"
output: github_document
---

```{r}
library(tidyverse)
library(purrr)
library(modelr)
```

## Problem 1

Load and clean the data for regression analysis (i.e. convert numeric to factor where appropriate, check for missing data, etc.).
```{r import_data}
birthweight_df = 
  read_csv("birthweight.csv") %>%
  mutate(babysex = factor(babysex, levels = c(1,2))) %>%
  mutate(frace = factor(frace, levels = c(1,2,3,4,8,9))) %>%
  mutate(malform = factor(malform, levels = c(0,1))) %>%
  mutate(mrace = factor(mrace, levels = c(1,2,3,4,8)))
```

Propose a regression model for birthweight. 

First I am going to investigate the data we have to determine which variables might be appropriate for inclusion. 
```{r}
unique(pull(birthweight_df, pnumlbw))
unique(pull(birthweight_df, pnumsga))
```
* All values of pnumlbw (previous number of low birth weight babies) are 0. Will not be an informative variable for inclusion in the model. 

* All values of pnumsga (number of prior small for gestational age babies) are 0. Will not be an informative variable for inclusion in the model. 

At my first pass at a model, I will include variables that I think are most appropriate. 
```{r model0}
model0 = lm(bwt ~ delwt + frace + mrace + smoken + gaweeks + ppbmi + momage + 
                  wtgain + malform, data = birthweight_df)

summary(model0)
```
Based on these results, it looks like frace, momage and malform are not significant predictors of bwt. I will remove these variables from the next iteration of the model. I will also add additional variables that may be appropriate. 

```{r model1}
model1 = lm(bwt ~ delwt + mrace + smoken + gaweeks + ppbmi + babysex + bhead + blength + 
                  parity, data = birthweight_df)

summary(model1)

model1 %>%
  broom::tidy()
```

Diagnostics
```{r}
modelr::add_residuals(birthweight_df, model1)

modelr::add_predictions(birthweight_df, model1)

birthweight_df %>%
  modelr::add_residuals(model1) %>%
  modelr::add_predictions(model1) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point()
```

Compare your model to two others:

* One using length at birth and gestational age as predictors (main effects only)

* One using head circumference, length, sex, and all interactions (including the three-way interaction) between these

```{r comparison_models}
model2 = lm(bwt ~ blength + gaweeks, data = birthweight_df)
model3 = lm(bwt ~ bhead + blength + babysex + bhead * blength + bhead * babysex +
                  blength * babysex + bhead * blength * babysex, data = birthweight_df)
```

Make this comparison in terms of the cross-validated prediction error
```{r}
cv_df =
  crossv_mc(birthweight_df, 50) %>%
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cv_df2 = 
cv_df %>%
  mutate(
    model1 = map(train, ~lm(bwt ~ delwt + mrace + smoken + gaweeks + 
                                  ppbmi + babysex + bhead + blength + parity, data = .x)), 
    model2 = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)), 
    model3 = map(train, ~lm(bwt ~ bhead + blength * babysex * bhead, data = .x))
  ) %>%
  mutate(
    rmse_model1 = map2_dbl(model1, test, ~rmse(model = .x, data = .y)), 
    rmse_model2 = map2_dbl(model2, test, ~rmse(model = .x, data = .y)),
    rmse_model3 = map2_dbl(model3, test, ~rmse(model = .x, data = .y))
  )
```

Look at output
```{r}
cv_df2 %>% 
  select(
    starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
   ggplot(aes(x = model, y = rmse)) +
  geom_boxplot()
```

## Problem 2

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

