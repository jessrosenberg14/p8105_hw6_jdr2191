p8105_hw6_jdr2191
================

``` r
library(tidyverse)
```

    ## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──

    ## ✓ ggplot2 3.3.5     ✓ purrr   0.3.4
    ## ✓ tibble  3.1.5     ✓ dplyr   1.0.7
    ## ✓ tidyr   1.1.4     ✓ stringr 1.4.0
    ## ✓ readr   2.0.2     ✓ forcats 0.5.1

    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## x dplyr::filter() masks stats::filter()
    ## x dplyr::lag()    masks stats::lag()

``` r
library(purrr)
library(modelr)
library(viridis)
```

    ## Loading required package: viridisLite

## Problem 1

Load and clean the data for regression analysis (i.e. convert numeric to
factor where appropriate, check for missing data, etc.).

``` r
birthweight_df = 
  read_csv("birthweight.csv") %>%
  mutate(babysex = factor(babysex, levels = c(1,2))) %>%
  mutate(frace = factor(frace, levels = c(1,2,3,4,8,9))) %>%
  mutate(malform = factor(malform, levels = c(0,1))) %>%
  mutate(mrace = factor(mrace, levels = c(1,2,3,4,8)))
```

    ## Rows: 4342 Columns: 20

    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (20): babysex, bhead, blength, bwt, delwt, fincome, frace, gaweeks, malf...

    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

Propose a regression model for birthweight.

First I am going to investigate the data we have to determine which
variables might be appropriate for inclusion.

``` r
unique(pull(birthweight_df, pnumlbw))
```

    ## [1] 0

``` r
unique(pull(birthweight_df, pnumsga))
```

    ## [1] 0

-   All values of pnumlbw (previous number of low birth weight babies)
    are 0. Will not be an informative variable for inclusion in the
    model.

-   All values of pnumsga (number of prior small for gestational age
    babies) are 0. Will not be an informative variable for inclusion in
    the model.

At my first pass at a model, I will include variables that I think are
most appropriate.

``` r
model0 = lm(bwt ~ delwt + frace + mrace + smoken + gaweeks + ppbmi + momage + 
                  wtgain + malform, data = birthweight_df)

summary(model0)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ delwt + frace + mrace + smoken + gaweeks + 
    ##     ppbmi + momage + wtgain + malform, data = birthweight_df)
    ## 
    ## Residuals:
    ##      Min       1Q   Median       3Q      Max 
    ## -1716.13  -255.51     9.43   275.60  1511.74 
    ## 
    ## Coefficients:
    ##              Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept)  505.2994    97.4790   5.184 2.27e-07 ***
    ## delwt          7.7922     0.6311  12.348  < 2e-16 ***
    ## frace2      -118.8169    71.3568  -1.665   0.0960 .  
    ## frace3       -49.7858   107.2948  -0.464   0.6427    
    ## frace4       -88.8815    69.1295  -1.286   0.1986    
    ## frace8       -12.3111   114.6442  -0.107   0.9145    
    ## mrace2      -170.1333    71.3047  -2.386   0.0171 *  
    ## mrace3       -31.8849   111.3277  -0.286   0.7746    
    ## mrace4       -30.4781    69.8267  -0.436   0.6625    
    ## smoken       -11.8404     0.8975 -13.192  < 2e-16 ***
    ## gaweeks       52.3785     2.1004  24.938  < 2e-16 ***
    ## ppbmi        -21.9358     3.9733  -5.521 3.57e-08 ***
    ## momage         1.0741     1.8111   0.593   0.5532    
    ## wtgain         2.0375     0.8847   2.303   0.0213 *  
    ## malform1     -30.6748   109.3574  -0.281   0.7791    
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 422.1 on 4327 degrees of freedom
    ## Multiple R-squared:  0.3228, Adjusted R-squared:  0.3206 
    ## F-statistic: 147.3 on 14 and 4327 DF,  p-value: < 2.2e-16

Based on these results, it looks like frace, momage and malform are not
significant predictors of bwt. I will remove these variables from the
next iteration of the model. I will also add additional variables that
may be appropriate.

``` r
model1 = lm(bwt ~ delwt + mrace + smoken + gaweeks + ppbmi + babysex + bhead + blength + 
                  parity, data = birthweight_df)

summary(model1)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ delwt + mrace + smoken + gaweeks + ppbmi + 
    ##     babysex + bhead + blength + parity, data = birthweight_df)
    ## 
    ## Residuals:
    ##      Min       1Q   Median       3Q      Max 
    ## -1109.86  -182.66    -4.67   176.19  2332.72 
    ## 
    ## Coefficients:
    ##               Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept) -5668.9277   101.1180 -56.063  < 2e-16 ***
    ## delwt           3.6182     0.2842  12.730  < 2e-16 ***
    ## mrace2       -144.4365     9.2061 -15.689  < 2e-16 ***
    ## mrace3        -77.5044    42.2866  -1.833 0.066896 .  
    ## mrace4       -102.3222    18.8609  -5.425 6.11e-08 ***
    ## smoken         -4.8796     0.5857  -8.331  < 2e-16 ***
    ## gaweeks        11.8295     1.4591   8.107 6.68e-16 ***
    ## ppbmi         -12.5487     1.9161  -6.549 6.47e-11 ***
    ## babysex2       27.8875     8.4551   3.298 0.000981 ***
    ## bhead         131.2566     3.4447  38.104  < 2e-16 ***
    ## blength        74.7819     2.0181  37.055  < 2e-16 ***
    ## parity         95.9560    40.3408   2.379 0.017420 *  
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 272.5 on 4330 degrees of freedom
    ## Multiple R-squared:  0.7176, Adjusted R-squared:  0.7169 
    ## F-statistic:  1000 on 11 and 4330 DF,  p-value: < 2.2e-16

``` r
model1 %>%
  broom::tidy()
```

    ## # A tibble: 12 × 5
    ##    term        estimate std.error statistic   p.value
    ##    <chr>          <dbl>     <dbl>     <dbl>     <dbl>
    ##  1 (Intercept) -5669.     101.       -56.1  0        
    ##  2 delwt           3.62     0.284     12.7  1.81e- 36
    ##  3 mrace2       -144.       9.21     -15.7  5.37e- 54
    ##  4 mrace3        -77.5     42.3       -1.83 6.69e-  2
    ##  5 mrace4       -102.      18.9       -5.43 6.11e-  8
    ##  6 smoken         -4.88     0.586     -8.33 1.06e- 16
    ##  7 gaweeks        11.8      1.46       8.11 6.68e- 16
    ##  8 ppbmi         -12.5      1.92      -6.55 6.47e- 11
    ##  9 babysex2       27.9      8.46       3.30 9.81e-  4
    ## 10 bhead         131.       3.44      38.1  3.14e-274
    ## 11 blength        74.8      2.02      37.1  2.56e-261
    ## 12 parity         96.0     40.3        2.38 1.74e-  2

Diagnostics

``` r
modelr::add_residuals(birthweight_df, model1)
```

    ## # A tibble: 4,342 × 21
    ##    babysex bhead blength   bwt delwt fincome frace gaweeks malform menarche
    ##    <fct>   <dbl>   <dbl> <dbl> <dbl>   <dbl> <fct>   <dbl> <fct>      <dbl>
    ##  1 2          34      51  3629   177      35 1        39.9 0             13
    ##  2 1          34      48  3062   156      65 2        25.9 0             14
    ##  3 2          36      50  3345   148      85 1        39.9 0             12
    ##  4 1          34      52  3062   157      55 1        40   0             14
    ##  5 2          34      52  3374   156       5 1        41.6 0             13
    ##  6 1          33      52  3374   129      55 1        40.7 0             12
    ##  7 2          33      46  2523   126      96 2        40.3 0             14
    ##  8 2          33      49  2778   140       5 1        37.4 0             12
    ##  9 1          36      52  3515   146      85 1        40.3 0             11
    ## 10 1          33      50  3459   169      75 2        40.7 0             12
    ## # … with 4,332 more rows, and 11 more variables: mheight <dbl>, momage <dbl>,
    ## #   mrace <fct>, parity <dbl>, pnumlbw <dbl>, pnumsga <dbl>, ppbmi <dbl>,
    ## #   ppwt <dbl>, smoken <dbl>, wtgain <dbl>, resid <dbl>

``` r
modelr::add_predictions(birthweight_df, model1)
```

    ## # A tibble: 4,342 × 21
    ##    babysex bhead blength   bwt delwt fincome frace gaweeks malform menarche
    ##    <fct>   <dbl>   <dbl> <dbl> <dbl>   <dbl> <fct>   <dbl> <fct>      <dbl>
    ##  1 2          34      51  3629   177      35 1        39.9 0             13
    ##  2 1          34      48  3062   156      65 2        25.9 0             14
    ##  3 2          36      50  3345   148      85 1        39.9 0             12
    ##  4 1          34      52  3062   157      55 1        40   0             14
    ##  5 2          34      52  3374   156       5 1        41.6 0             13
    ##  6 1          33      52  3374   129      55 1        40.7 0             12
    ##  7 2          33      46  2523   126      96 2        40.3 0             14
    ##  8 2          33      49  2778   140       5 1        37.4 0             12
    ##  9 1          36      52  3515   146      85 1        40.3 0             11
    ## 10 1          33      50  3459   169      75 2        40.7 0             12
    ## # … with 4,332 more rows, and 11 more variables: mheight <dbl>, momage <dbl>,
    ## #   mrace <fct>, parity <dbl>, pnumlbw <dbl>, pnumsga <dbl>, ppbmi <dbl>,
    ## #   ppwt <dbl>, smoken <dbl>, wtgain <dbl>, pred <dbl>

``` r
birthweight_df %>%
  modelr::add_residuals(model1) %>%
  modelr::add_predictions(model1) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point(color = "#21A8BD") +
  labs(x = "Fitted Values", y = "Residuals") + 
  ggtitle("Plot of model residuals against fitted values") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) 
```

![](p8105_hw6_jdr2191_files/figure-gfm/model_diagnostics-1.png)<!-- -->
Compare your model to two others:

-   One using length at birth and gestational age as predictors (main
    effects only)

-   One using head circumference, length, sex, and all interactions
    (including the three-way interaction) between these

``` r
model2 = lm(bwt ~ blength + gaweeks, data = birthweight_df)
model3 = lm(bwt ~ bhead + blength + babysex + bhead * blength + bhead * babysex +
                  blength * babysex + bhead * blength * babysex, data = birthweight_df)
```

Make this comparison in terms of the cross-validated prediction error

``` r
cv_df =
  crossv_mc(birthweight_df, 50) %>%
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cv_df2 = 
cv_df %>%
  mutate(
    model1 = map(train, ~lm(bwt ~ delwt + mrace + smoken + gaweeks + 
                                  ppbmi + babysex + bhead + blength + parity, data = .x)), 
    model2 = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)), 
    model3 = map(train, ~lm(bwt ~ bhead + blength * babysex * bhead, data = .x))
  ) %>%
  mutate(
    rmse_model1 = map2_dbl(model1, test, ~rmse(model = .x, data = .y)), 
    rmse_model2 = map2_dbl(model2, test, ~rmse(model = .x, data = .y)),
    rmse_model3 = map2_dbl(model3, test, ~rmse(model = .x, data = .y))
  )
```

Look at output

``` r
cv_df2 %>% 
  select(
    starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
    ggplot(aes(x = model, y = rmse, fill = model)) +
    geom_boxplot() +
    scale_fill_viridis_d(option = "D") +
    labs(x = "Model", y = "RMSE", col = "Model") +
    ggtitle("RMSE Plots for All Models") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

![](p8105_hw6_jdr2191_files/figure-gfm/cv_investigation-1.png)<!-- -->

## Problem 2

Importing weather dataset.

``` r
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

    ## Registered S3 method overwritten by 'hoardr':
    ##   method           from
    ##   print.cache_info httr

    ## using cached file: ~/Library/Caches/R/noaa_ghcnd/USW00094728.dly

    ## date created (size, mb): 2021-11-27 13:23:12 (7.614)

    ## file min/max dates: 1869-01-01 / 2021-11-30

Boostrapping weather dataset.

``` r
weather_df2 =
weather_df %>% 
  modelr::bootstrap(n = 5000) %>% 
  mutate(
    models = map(strap, ~ lm(tmax ~ tmin, data = .x)),
    glance = map(models, broom::glance),
    results = map(models, broom::tidy)) %>%
  unnest(results) %>%
  unnest(glance, names_repair = "universal") %>%
  select(strap, .id, models, r.squared, term, estimate)
```

    ## New names:
    ## * statistic -> statistic...7
    ## * p.value -> p.value...8
    ## * statistic -> statistic...19
    ## * p.value -> p.value...20

``` r
weather_df3 = 
  weather_df2 %>%
  mutate(term = if_else(term != "tmin", "Intercept", "tmin"))

wide_weather_df = 
  weather_df3 %>%
  select(term, estimate, .id, r.squared) %>%
  pivot_wider(
    names_from = "term",
    values_from = "estimate"
  ) 

weather_df4 = 
wide_weather_df %>%
  mutate(logb0b1 = log(Intercept)*log(tmin)) %>%
  select(.id, r.squared, logb0b1) 
```

Generate plots of R squared and Log(beta0 \* beta1)

``` r
weather_df4 %>%
  ggplot(aes(x = r.squared)) + 
  geom_density(color = "#6D58B0", size = 1) +
  labs(x = "R Squared", y = "Density") +
  ggtitle("Distribution of R Squared Values for 5,000 Bootstrap Samples") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) 
```

![](p8105_hw6_jdr2191_files/figure-gfm/weather_df_plots-1.png)<!-- -->

``` r
weather_df4 %>%
  ggplot(aes(x = logb0b1)) + 
  geom_density(color = "#6D58B0", size = 1) +
  labs(x = "Log (Beta 0 * Beta 1)", y = "Density") +
  ggtitle("Distribution of Log(Beta 0 * Beta 1) for 5,000 Bootstrap Samples") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) 
```

![](p8105_hw6_jdr2191_files/figure-gfm/weather_df_plots-2.png)<!-- -->

Identify the 2.5% and 97.5% quantiles to provide 95% confidence
intervals for R squared and Log (Beta 0 \* Beta 1)

``` r
weather_df5 = 
  weather_df4 %>%
  select(r.squared, logb0b1)

sapply(weather_df5, function(x) quantile(x, probs = c(0.025, 0.975))) %>%
  knitr::kable()
```

|       | r.squared |   logb0b1 |
|:------|----------:|----------:|
| 2.5%  | 0.8939555 | 0.0095708 |
| 97.5% | 0.9273899 | 0.1343350 |
